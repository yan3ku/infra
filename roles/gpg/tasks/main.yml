---
- name: Export GPG key on control node
  ansible.builtin.command: "gpg --batch --export-secret-key --armor {{ username }}"
  register: gpg_key_export
  delegate_to: localhost
  changed_when: false
  become: false

- name: Import private GPG key
  ansible.builtin.command:
    cmd: "gpg --batch --import"
  args:
    stdin: "{{ gpg_key_export.stdout }}"
  register: gpg_out
  changed_when: "'imported: 1' in gpg_out.stderr"
  become_user: "{{ item }}"
  with_items:
    - "{{ username }}"
    - root

- name: Deploy authget
  ansible.builtin.template:
    src: templates/authget.j2
    dest: /usr/bin/authget
    owner: root
    group: root
    mode: '0755'
