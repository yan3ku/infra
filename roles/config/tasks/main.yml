---
- name: Install packages
  ansible.builtin.package:
    name:
      - stow
      - git
      - git-secret
      - git-secrets
    state: present

- name: Copy private SSH key
  ansible.builtin.copy:
    src: "~/.ssh/id_ed25519"
    dest: "{{ user_home }}/.ssh/id_ed25519"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0600'

- name: Ensure github.com is in known_hosts
  ansible.builtin.known_hosts:
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    path: "{{ user_home }}/.ssh/known_hosts"
    state: present
  become: false

- name: Clone config repo
  ansible.builtin.git:
    repo: '{{ user_git }}'
    dest: "{{ user_conf }}"
    version: master
    update: false
  become: false
  notify:
    - Stow config
    - Reset files adopted by stow
